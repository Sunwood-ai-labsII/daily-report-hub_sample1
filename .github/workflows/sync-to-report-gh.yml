name: Sync to Daily Report Hub v2.0
on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, closed]

# 週の開始日を制御する設定
env:
  WEEK_START_DAY: 1 # 週の開始日 (0=日曜日, 1=月曜日, 2=火曜日, 3=水曜日, 4=木曜日, 5=金曜日, 6=土曜日)
  AUTO_APPROVE: false # プルリクエストの自動承認 (true/false) - 自分のPRは承認不可
  AUTO_MERGE: false # プルリクエストの自動マージ (true/false) - 承認なしではマージ不可
  CREATE_PR: false # 完全自動化のため直接プッシュ

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全履歴を取得してその日の全コミットを追跡

      - name: Make scripts executable
        run: chmod +x .github/scripts/*.sh

      - name: Calculate week information
        run: ./.github/scripts/calculate-week-info.sh ${{ env.WEEK_START_DAY }}

      - name: Analyze Git activity
        run: ./.github/scripts/analyze-git-activity.sh

      - name: Generate Markdown reports
        run: ./.github/scripts/generate-markdown-reports.sh

      - name: Clone report hub and create structure
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          REPORT_HUB_REPO: ${{ vars.REPORT_HUB_REPO || 'Sunwood-ai-labsII/daily-report-hub' }}
        run: |
          # Git設定
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # daily-report-hubをクローン
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${REPORT_HUB_REPO}.git daily-report-hub

      - name: Create Docusaurus structure
        run: ./.github/scripts/create-docusaurus-structure.sh

      - name: Sync to report hub with PR flow (GitHub CLI)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          REPORT_HUB_REPO: ${{ vars.REPORT_HUB_REPO || 'Sunwood-ai-labsII/daily-report-hub' }}
          AUTO_APPROVE: ${{ env.AUTO_APPROVE }}
          AUTO_MERGE: ${{ env.AUTO_MERGE }}
          CREATE_PR: ${{ env.CREATE_PR }}
        run: ./.github/scripts/sync-to-hub-gh.sh
