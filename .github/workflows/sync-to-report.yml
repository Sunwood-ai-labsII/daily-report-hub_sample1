name: Sync to Daily Report Hub v1.1
on:
  push:
    branches: [main, master]
  pull_request:
    types: [merged]

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ãã®æ—¥ã®å…¨ã‚³ãƒŸãƒƒãƒˆã‚’è¿½è·¡
      
      - name: Get repository info and daily activities
        run: |
          # ãƒªãƒã‚¸ãƒˆãƒªåã¨æ—¥ä»˜ã‚’å–å¾—
          REPO_NAME=$(basename $GITHUB_REPOSITORY)
          DATE=$(date '+%Y-%m-%d')
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          
          echo "ğŸ” Fetching all commits for $DATE..."
          
          # ãã®æ—¥ã®å…¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ï¼ˆæ™‚åˆ»é †ï¼‰
          git log --since="$DATE 00:00:00" --until="$DATE 23:59:59" \
            --pretty=format:"%h|%s|%an|%ad" --date=format:'%H:%M:%S' \
            --reverse > daily_commits_raw.txt
          
          # ã‚³ãƒŸãƒƒãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          COMMIT_COUNT=$(wc -l < daily_commits_raw.txt)
          echo "ğŸ“Š Found $COMMIT_COUNT commits for today"
          
          # ãã®æ—¥ã®å…¨ã¦ã®å·®åˆ†ã‚’çµ±åˆï¼ˆå®‰å…¨ãªæ–¹æ³•ã§ï¼‰
          if [ $COMMIT_COUNT -gt 0 ]; then
            FIRST_COMMIT_TODAY=$(git log --since="$DATE 00:00:00" --pretty=format:"%H" --reverse | head -1)
            LAST_COMMIT_TODAY=$(git log --since="$DATE 00:00:00" --pretty=format:"%H" | head -1)
            
            echo "First commit: $FIRST_COMMIT_TODAY"
            echo "Last commit: $LAST_COMMIT_TODAY"
            
            # è¦ªã‚³ãƒŸãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if git rev-parse --verify "$FIRST_COMMIT_TODAY^" >/dev/null 2>&1; then
              # è¦ªã‚³ãƒŸãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆ
              PARENT_OF_FIRST=$(git rev-parse $FIRST_COMMIT_TODAY^)
              git diff $PARENT_OF_FIRST..$LAST_COMMIT_TODAY --name-status > daily_cumulative_diff_raw.txt 2>/dev/null || echo "No diff available" > daily_cumulative_diff_raw.txt
              git diff $PARENT_OF_FIRST..$LAST_COMMIT_TODAY --stat > daily_diff_stats_raw.txt 2>/dev/null || echo "No stats available" > daily_diff_stats_raw.txt
              # ã‚³ãƒ¼ãƒ‰ã®è©³ç´°å·®åˆ†ã‚’å–å¾—
              git diff $PARENT_OF_FIRST..$LAST_COMMIT_TODAY > daily_code_diff_raw.txt 2>/dev/null || echo "No code diff available" > daily_code_diff_raw.txt
            else
              # åˆå›ã‚³ãƒŸãƒƒãƒˆã®å ´åˆï¼ˆè¦ªãŒå­˜åœ¨ã—ãªã„ï¼‰
              echo "Initial commit detected - showing all files as new"
              git diff --name-status 4b825dc642cb6eb9a060e54bf8d69288fbee4904..$LAST_COMMIT_TODAY > daily_cumulative_diff_raw.txt 2>/dev/null || \
              git ls-tree --name-status $LAST_COMMIT_TODAY > daily_cumulative_diff_raw.txt 2>/dev/null || \
              echo "A\t(all files added in initial commit)" > daily_cumulative_diff_raw.txt
              
              git diff --stat 4b825dc642cb6eb9a060e54bf8d69288fbee4904..$LAST_COMMIT_TODAY > daily_diff_stats_raw.txt 2>/dev/null || \
              echo "Initial commit - all files added" > daily_diff_stats_raw.txt
              
              # åˆå›ã‚³ãƒŸãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰å†…å®¹
              git show $LAST_COMMIT_TODAY > daily_code_diff_raw.txt 2>/dev/null || echo "No code diff available" > daily_code_diff_raw.txt
            fi
          else
            echo "No commits found for today" > daily_cumulative_diff_raw.txt
            echo "No commits found for today" > daily_diff_stats_raw.txt
            echo "No commits found for today" > daily_code_diff_raw.txt
          fi
          
          # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®å€‹åˆ¥å·®åˆ†
          git diff HEAD~1 --name-status > latest_diff_raw.txt 2>/dev/null || echo "No recent diff available" > latest_diff_raw.txt
          git diff HEAD~1 > latest_code_diff_raw.txt 2>/dev/null || echo "No recent code diff available" > latest_code_diff_raw.txt
          
          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆå„è¡Œã«4ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ï¼‰
          add_indent() {
            sed 's/^/    /' "$1"
          }
          
          # ã‚³ãƒŸãƒƒãƒˆè©³ç´°ã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ“ Daily Commits"
            echo ""
            if [ -s daily_commits_raw.txt ]; then
              while IFS='|' read -r hash subject author time; do
                echo "## â° $time - \`$hash\`"
                echo "**$subject**"
                echo "*by $author*"
                echo ""
              done < daily_commits_raw.txt
            else
              echo "*No commits found for today.*"
            fi
          } > daily_commits.md
          
          # ç´¯ç©å·®åˆ†ã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ“‹ Daily File Changes"
            echo ""
            if [ -s daily_cumulative_diff_raw.txt ]; then
              while read -r line; do
                if [ ! -z "$line" ]; then
                  status=$(echo "$line" | cut -f1)
                  file=$(echo "$line" | cut -f2)
                  case $status in
                    A) echo "- ğŸ†• **Added:** \`$file\`" ;;
                    M) echo "- âœï¸ **Modified:** \`$file\`" ;;
                    D) echo "- ğŸ—‘ï¸ **Deleted:** \`$file\`" ;;
                    R*) echo "- ğŸ”„ **Renamed:** \`$file\`" ;;
                    *) echo "- ğŸ“ **$status:** \`$file\`" ;;
                  esac
                fi
              done < daily_cumulative_diff_raw.txt
            else
              echo "*No file changes today.*"
            fi
          } > daily_cumulative_diff.md
          
          # çµ±è¨ˆã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ“ˆ Daily Statistics"
            echo ""
            add_indent daily_diff_stats_raw.txt
          } > daily_diff_stats.md
          
          # ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ’» Daily Code Changes"
            echo ""
            echo "## Full Diff"
            echo ""
            add_indent daily_code_diff_raw.txt
          } > daily_code_diff.md
          
          # æœ€æ–°å·®åˆ†ã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ”„ Latest Changes (File List)"
            echo ""
            if [ -s latest_diff_raw.txt ]; then
              while read -r line; do
                if [ ! -z "$line" ]; then
                  status=$(echo "$line" | cut -f1)
                  file=$(echo "$line" | cut -f2)
                  case $status in
                    A) echo "- ğŸ†• **Added:** \`$file\`" ;;
                    M) echo "- âœï¸ **Modified:** \`$file\`" ;;
                    D) echo "- ğŸ—‘ï¸ **Deleted:** \`$file\`" ;;
                    R*) echo "- ğŸ”„ **Renamed:** \`$file\`" ;;
                    *) echo "- ğŸ“ **$status:** \`$file\`" ;;
                  esac
                fi
              done < latest_diff_raw.txt
            else
              echo "*No recent changes.*"
            fi
          } > latest_diff.md
          
          # æœ€æ–°ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’Markdownå½¢å¼ã§ä½œæˆ
          {
            echo "# ğŸ”„ Latest Code Changes"
            echo ""
            add_indent latest_code_diff_raw.txt
          } > latest_code_diff.md
          
          # è©³ç´°ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚µãƒãƒªãƒ¼ã‚’Markdownå½¢å¼ã§ä½œæˆ
          if [ -s daily_commits_raw.txt ]; then
            FIRST_COMMIT_TIME=$(head -1 daily_commits_raw.txt | cut -d'|' -f4)
            LAST_COMMIT_TIME=$(tail -1 daily_commits_raw.txt | cut -d'|' -f4)
            FILES_CHANGED=$(grep -c '^' daily_cumulative_diff_raw.txt 2>/dev/null || echo "0")
          else
            FIRST_COMMIT_TIME="N/A"
            LAST_COMMIT_TIME="N/A" 
            FILES_CHANGED=0
          fi
          
          # ãƒ¡ã‚¤ãƒ³ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          {
            echo "# ğŸ“… Daily Activity Report"
            echo ""
            echo "## ğŸ“Š Summary"
            echo "| Item | Value |"
            echo "|------|-------|"
            echo "| Repository | \`$GITHUB_REPOSITORY\` |"
            echo "| Date | $DATE |"
            echo "| Total Commits | **$COMMIT_COUNT** |"
            echo "| Files Changed | **$FILES_CHANGED** |"
            echo "| First Activity | $FIRST_COMMIT_TIME |"
            echo "| Last Activity | $LAST_COMMIT_TIME |"
            echo "| Sync Time | $(date '+%H:%M:%S') |"
            echo ""
            
            if [ -s daily_commits_raw.txt ]; then
              echo "## ğŸ“ Commit Details"
              echo ""
              while IFS='|' read -r hash subject author time; do
                echo "### â° $time - \`$hash\`"
                echo "**$subject**"
                echo "*by $author*"
                echo ""
              done < daily_commits_raw.txt
              
              echo "## ğŸ“ˆ File Changes Statistics"
              echo ""
              add_indent daily_diff_stats_raw.txt
              echo ""
              
              echo "## ğŸ“‹ Changed Files List"
              echo ""
              while read -r line; do
                if [ ! -z "$line" ]; then
                  status=$(echo "$line" | cut -f1)
                  file=$(echo "$line" | cut -f2)
                  case $status in
                    A) echo "- ğŸ†• **Added:** \`$file\`" ;;
                    M) echo "- âœï¸ **Modified:** \`$file\`" ;;
                    D) echo "- ğŸ—‘ï¸ **Deleted:** \`$file\`" ;;
                    R*) echo "- ğŸ”„ **Renamed:** \`$file\`" ;;
                    *) echo "- ğŸ“ **$status:** \`$file\`" ;;
                  esac
                fi
              done < daily_cumulative_diff_raw.txt
              echo ""
              
            else
              echo "## ğŸ“ Commit Details"
              echo ""
              echo "*No commits found for today.*"
              echo ""
            fi
            
            echo "---"
            echo "*Generated by GitHub Actions at $(date '+%Y-%m-%d %H:%M:%S')*"
          } > daily_summary.md
          
          echo "âœ… Daily activity analysis complete!"
      
      - name: Clone and update report hub
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Gitè¨­å®š
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # daily-report-hubã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/Sunwood-ai-labs/daily-report-hub.git
          
          # æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
          TARGET_DIR="daily-report-hub/activities/$DATE/$REPO_NAME"
          mkdir -p "$TARGET_DIR"
          
          # README.mdã‚’ã‚³ãƒ”ãƒ¼
          cp README.md "$TARGET_DIR/" 2>/dev/null || echo "# $REPO_NAME" > "$TARGET_DIR/README.md"
          
          # å½“æ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå…¨ã¦.mdãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          cp daily_commits.md "$TARGET_DIR/"
          cp daily_cumulative_diff.md "$TARGET_DIR/"
          cp daily_diff_stats.md "$TARGET_DIR/"
          cp daily_code_diff.md "$TARGET_DIR/"
          cp latest_diff.md "$TARGET_DIR/"
          cp latest_code_diff.md "$TARGET_DIR/"
          cp daily_summary.md "$TARGET_DIR/"
          
          # è©³ç´°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
          COMMIT_COUNT=$(wc -l < daily_commits_raw.txt)
          FILES_CHANGED=$(grep -c '^' daily_cumulative_diff_raw.txt 2>/dev/null || echo "0")
          
          cat > "$TARGET_DIR/metadata.json" << EOF
          {
            "repository": "$GITHUB_REPOSITORY",
            "date": "$DATE",
            "branch": "$GITHUB_REF_NAME",
            "latest_commit_sha": "$GITHUB_SHA",
            "sync_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "$GITHUB_RUN_ID",
            "daily_commit_count": $COMMIT_COUNT,
            "daily_files_changed": $FILES_CHANGED,
            "has_activity": $([ $COMMIT_COUNT -gt 0 ] && echo "true" || echo "false"),
            "files": {
              "summary": "daily_summary.md",
              "commits": "daily_commits.md",
              "file_changes": "daily_cumulative_diff.md",
              "stats": "daily_diff_stats.md",
              "code_diff": "daily_code_diff.md",
              "latest_diff": "latest_diff.md",
              "latest_code_diff": "latest_code_diff.md"
            }
          }
          EOF
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          cd daily-report-hub
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Daily sync: $REPO_NAME ($DATE) - $COMMIT_COUNT commits"
            git push
          fi
