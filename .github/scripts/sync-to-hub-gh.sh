#!/bin/bash

# ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ–ã«åŒæœŸã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆGitHub CLIä½¿ç”¨ç‰ˆãƒ»å¼·åˆ¶ä¸Šæ›¸ãå¯¾å¿œï¼‰

set -e

# å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
: ${GITHUB_TOKEN:?}
: ${REPORT_HUB_REPO:?}
: ${TARGET_DIR:?}
: ${REPO_NAME:?}
: ${DATE:?}
: ${WEEK_NUMBER:?}

# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
CREATE_PR=${CREATE_PR:-true}
AUTO_APPROVE=${AUTO_APPROVE:-false}
AUTO_MERGE=${AUTO_MERGE:-false}

# ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç’°å¢ƒå¤‰æ•°ã‚’è¡¨ç¤º
echo "ğŸ” Environment Variables:"
echo "  CREATE_PR: $CREATE_PR"
echo "  AUTO_APPROVE: $AUTO_APPROVE"
echo "  AUTO_MERGE: $AUTO_MERGE"

# daily-report-hubã¯æ—¢ã«ã‚¯ãƒ­ãƒ¼ãƒ³æ¸ˆã¿

# README.mdã‚’ã‚³ãƒ”ãƒ¼
cp README.md "$TARGET_DIR/" 2>/dev/null || echo "# $REPO_NAME" > "$TARGET_DIR/README.md"

# å½“æ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå…¨ã¦.mdãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
cp daily_commits.md "$TARGET_DIR/"
cp daily_cumulative_diff.md "$TARGET_DIR/"
cp daily_diff_stats.md "$TARGET_DIR/"
cp daily_code_diff.md "$TARGET_DIR/"
cp latest_diff.md "$TARGET_DIR/"
cp latest_code_diff.md "$TARGET_DIR/"
cp daily_summary.md "$TARGET_DIR/"

# è©³ç´°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
COMMIT_COUNT=$(wc -l < daily_commits_raw.txt)
FILES_CHANGED=$(grep -c '^' daily_cumulative_diff_raw.txt 2>/dev/null || echo "0")

cat > "$TARGET_DIR/metadata.json" << EOF
{
  "repository": "$GITHUB_REPOSITORY",
  "date": "$DATE",
  "week_folder": "$WEEK_FOLDER",
  "week_number": $WEEK_NUMBER,
  "week_start_date": "$WEEK_START_DATE",
  "week_end_date": "$WEEK_END_DATE",
  "branch": "$GITHUB_REF_NAME",
  "latest_commit_sha": "$GITHUB_SHA",
  "sync_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "workflow_run": "$GITHUB_RUN_ID",
  "daily_commit_count": $COMMIT_COUNT,
  "daily_files_changed": $FILES_CHANGED,
  "has_activity": $([ $COMMIT_COUNT -gt 0 ] && echo "true" || echo "false"),
  "pr_flow": {
    "create_pr": $CREATE_PR,
    "auto_approve": $AUTO_APPROVE,
    "auto_merge": $AUTO_MERGE
  },
  "files": {
    "readme": "README.md",
    "summary": "daily_summary.md",
    "commits": "daily_commits.md",
    "file_changes": "daily_cumulative_diff.md",
    "stats": "daily_diff_stats.md",
    "code_diff": "daily_code_diff.md",
    "latest_diff": "latest_diff.md",
    "latest_code_diff": "latest_code_diff.md"
  }
}
EOF

# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ã¾ãŸã¯ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥
cd daily-report-hub

# æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
git fetch origin main
git checkout main
git pull origin main

# å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
git add .

# ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªã‚»ãƒƒãƒˆå‰ã«ï¼‰
if git diff --staged --quiet; then
  echo "No changes to commit"
  exit 0
fi

COMMIT_MESSAGE="ğŸ“Š Weekly sync: $REPO_NAME ($DATE) - Week $WEEK_NUMBER - $COMMIT_COUNT commits"

if [ "$CREATE_PR" = "true" ]; then
  # æ—¢å­˜ã®åŒåPRãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ï¼ˆå®‰å…¨ã«ï¼‰
  BRANCH_NAME="sync/$REPO_NAME-$DATE"
  
  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
  git branch -D "$BRANCH_NAME" 2>/dev/null || true
  
  # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
  git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
  
  echo "ğŸ”€ Creating pull request flow with branch: $BRANCH_NAME"
  
  # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
  git checkout -b "$BRANCH_NAME"
  
  # ã‚³ãƒŸãƒƒãƒˆä½œæˆè€…ã‚’è¨­å®š
  git config user.name "Yukihiko Kondo"
  git config user.email "yukihiko.fuyuki@example.com"
  
  # ã‚³ãƒŸãƒƒãƒˆã—ã¦å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥
  git commit -m "$COMMIT_MESSAGE"
  git push origin "$BRANCH_NAME"
  
  # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é–‰ã˜ã‚‹
  echo "ğŸ” Checking for existing pull requests..."
  EXISTING_PRS=$(gh pr list --repo "$REPORT_HUB_REPO" --author "@me" --state open --json number,headRefName --jq '.[] | select(.headRefName | startswith("sync/'$REPO_NAME'")) | .number' 2>/dev/null || echo "")
  
  if [ -n "$EXISTING_PRS" ]; then
    echo "ğŸ—‘ï¸ Closing existing PRs for this repo..."
    echo "$EXISTING_PRS" | while read pr_number; do
      if [ -n "$pr_number" ]; then
        gh pr close "$pr_number" --repo "$REPORT_HUB_REPO" --comment "Superseded by new daily sync" 2>/dev/null || true
      fi
    done
  fi
  
  # GitHub CLIã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
  PR_BODY="## ğŸ“Š Daily Report Sync

**Repository:** \`$GITHUB_REPOSITORY\`
**Date:** $DATE
**Week:** $WEEK_NUMBER ($WEEK_START_DATE to $WEEK_END_DATE)

### ğŸ“ˆ Activity Summary
- **Commits:** $COMMIT_COUNT
- **Files Changed:** $FILES_CHANGED
- **Sync Time:** $(date '+%Y-%m-%d %H:%M:%S')

### ğŸ“‹ Generated Files
- Daily summary report
- Commit details
- File changes
- Code differences
- Statistics

### âš™ï¸ Automation Settings
- **Auto Approve:** $AUTO_APPROVE
- **Auto Merge:** $AUTO_MERGE

---
*Auto-generated by GitHub Actions - Force overwrite enabled*"

  echo "ğŸ“ Creating pull request with GitHub CLI..."
  
  # GitHub CLIã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
  PR_URL=$(gh pr create \
    --title "$COMMIT_MESSAGE" \
    --body "$PR_BODY" \
    --base main \
    --head "$BRANCH_NAME" \
    --repo "$REPORT_HUB_REPO" 2>/dev/null || echo "")
  
  if [ -n "$PR_URL" ]; then
    echo "âœ… Pull request created: $PR_URL"
    
    # è‡ªå‹•æ‰¿èªãŒæœ‰åŠ¹ãªå ´åˆï¼ˆè‡ªåˆ†ã®PRã¯æ‰¿èªã§ããªã„ã®ã§æ³¨æ„ï¼‰
    if [ "$AUTO_APPROVE" = "true" ]; then
      echo "ğŸ‘ Auto-approving pull request..."
      if gh pr review "$PR_URL" --approve --body "âœ… Auto-approved by GitHub Actions" --repo "$REPORT_HUB_REPO" 2>/dev/null; then
        echo "âœ… Pull request approved"
      else
        echo "âš ï¸ Cannot approve own pull request. Manual approval required."
        AUTO_MERGE="false"  # æ‰¿èªã§ããªã„å ´åˆã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã‚‚ç„¡åŠ¹ã«ã™ã‚‹
      fi
    fi
    
    # è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹ãªå ´åˆ
    if [ "$AUTO_MERGE" = "true" ]; then
      echo "ğŸ”€ Auto-merging pull request..."
      sleep 3  # APIã®åæ˜ ã‚’å¾…ã¤
      
      if gh pr merge "$PR_URL" --squash --delete-branch --repo "$REPORT_HUB_REPO" 2>/dev/null; then
        echo "âœ… Pull request merged and branch deleted successfully"
      else
        echo "âš ï¸ Failed to auto-merge. Manual merge required."
        echo "PR URL: $PR_URL"
      fi
    else
      echo "ğŸ“‹ Pull request created and ready for manual review: $PR_URL"
    fi
  else
    echo "âŒ Failed to create pull request with GitHub CLI. Falling back to direct push."
    git checkout main
    git merge "$BRANCH_NAME" --strategy-option=theirs  # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ™‚ã¯æ–°ã—ã„å†…å®¹ã‚’å„ªå…ˆ
    git push origin main
    git branch -d "$BRANCH_NAME"
    git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
  fi
else
  # ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼
  echo "âš¡ Direct push mode"
  git commit -m "$COMMIT_MESSAGE"
  git push origin main
  echo "âœ… Successfully synced to report hub via direct push!"
fi
